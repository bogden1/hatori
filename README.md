
This repository contains the code for the Hansard web app hosted at https://brown-ccv.github.io/hatori. The code is divided into two parts, the front-end of the web-app and the statistics compiler.


### The Front-End of The Webapp

The webapp itself lives in the `docs/page/`, which is an NPM package. It has five views, and two of these — `front/` and `cloud/` — have their own visualizations generated by `generator.py`. 
	
- The `front` view contains a list of topics, with the 16 most popular words in each topic and the proportion of each topics with in the whole corpus. 

- Then we have the `home/` view, which contains the word cloud for each topic listed in a sectional order.

- The `map/` view shows the visualiation of the embedding of the topics into the Euclidean plane, each topic being a point (or rather a disk). 

- Clicking on the element corresponding to a topic in each of the previous topics brings you to the `topic/` page corresponding to that topic. Here you can see the distribution of the words in the topic, the significant documents for that topic and the proportion of the topic overtime. It can display data for multiple topics. Typing the topic ID number into the "Add Topic" text input on the top right corner and pressing enter will add the topic with the corresponding ID to the visualization. This view needs to make calls to the server (which we will talk about in the server section)

- Finally, clicking corpus words in the previous views will bring you to the `graph` page. This page displays the proportion/frequency of the words as a graph over time. Multiple words can be added for comparision.


### The Statistics Compiler

The statistics compiler is written in Python and is contained in the `serv` folder. It consists of an asset generator (`serv/generator.py`) and the data reader (`serv/reader.py`). 

The reader reads the data from the MALLET-generated file and compiles it into a digestible format. The generator takes data compiled by the reader and creates assets such as the json data file, the word clouds and the visualizations needed for the web-app. 


### The Server

Due to the staggering number of combinations of the list of topics. We cannot save the data for all combinations in a JSON file preloaded along with the webpage. Due to the staggering size of the corpus, we cannot load the corpus onto the webpage and generate the data on demand either. This calls for a server. The `topic` view is the only view that needs a server. The server finds important documents, the word distribution and the time distribution for a union of some combination topics. This comes in handy when multiple topics have the same content and should be looked at as one single topic.


### Minifying and Compiling Javascript 

The docs directory is an NPM repository. To initialize it, run
```bash
$ npm install
```
Then, to recompile each view, simply `cd` into each subdirectory and run `$ make`.


### Running Python

To run the server or the statistics compiler, run

```bash
$ pip install -r serv/requirements.txt
```

To generate the data, run
```bash
$ (cd serv && python generate_assets.py)
```

To start the server on port 5000, run
```bash
$ (cd serv && python run_server.py)
```

Settings can be configured in `generate_assets.py` and `run_server.py`. The server endpoint needs to be changed in `docs/page/topic/src/index.js` and the code recompiled.


### Running on Ubuntu 23.10 (Mantic)

#### Pre-requisites

```
sudo apt install python3-tk #This appears to be the way to get the tkinter module
sudo apt install git-lfs
#If this repository is already checked out then also: (cd hatori; git lfs install; git lfs pull)
```

#### Running the Front-End

In `hatori/docs/page/topic/src/index.js`:
* Edit `ENDPOINT` to point to where the back-end will be listening (e.g. `http://localhost:5000/`)
* Remove `../assets` from `this.shared = require("../../../../assts/json/shared.json")

In `hatori/docs/page/\*/makefile`:
Edit to comment out any use of `--watch`

[!NOTE]
The above edits have already been made in this fork, but you still may have a different `ENDPOINT`


```
(cd hatori/docs; npm install --legacy-peer-deps)
```

[!WARN]
The above is likely very insecure!

```
for x in `hatori/page/*`; do (cd "$x" && make); done
(cd hatori/docs; python3 -m http.server -b 127.0.0.1 5001) #alter parameters depending on where you want your front-end to listen
```

Site is now available at http://127.0.0.1:5001/home/

#### Running the Back-End

In `hatori/serv/src/visualizer/visualizer.py`:
Edit function `tsne` where it constructs an instance of `manifold.TSNE`: add an `init=random` parameter here. IIRC, some default changed and this gets us back to the original state of affairs

[!NOTE]
The above edit has already been made in this fork, as has an update to requirements.txt

```
mkvirtualenv hatori-backend
(cd hatori/serv; pip install -r requirements.txt) #requirements.txt has been updated by installing requirements without version restriction, then using pip freeze to record the resulting deps as a new requirements.txt
python generate_assets.py
python run_server.py
```

